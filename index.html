<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extra Transportes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{font-family:Arial;background:#f8f9fa;margin:0;padding:20px;text-align:center}
    .c{background:#fff;max-width:420px;margin:auto;padding:30px;border-radius:25px;box-shadow:0 15px 40px rgba(0,0,0,.2);overflow:hidden}
    .logo{width:210px;margin:30px auto 10px;display:block}
    input,button{width:90%;padding:16px;margin:12px auto;display:block;border-radius:12px;border:2px solid #007bff;font-size:18px;box-sizing:border-box}
    button{background:#007bff;color:#fff;font-weight:bold;cursor:pointer}
    .fotos{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0}
    .foto-prev{width:100px;height:100px;object-fit:cover;border-radius:10px;border:2px solid #007bff;position:relative}
    .remover{position:absolute;top:5px;right:5px;background:red;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;line-height:20px;cursor:pointer}
    #progress-container{width:90%;height:20px;background:#ddd;border-radius:10px;margin:15px auto;overflow:hidden;display:none}
    #progress-bar{height:100%;width:0;background:#007bff;transition:width 0.3s}
    #ok{margin-top:15px;font-weight:bold;color:green}
    h2{color:#007bff}
    .camera-actions{width:90%;margin:10px auto 0;display:flex;justify-content:center;gap:10px}
    .camera-actions button{width:100%;padding:14px;font-size:16px;margin:0}
    .obs p{font-size:18px !important;line-height:1.6;margin:16px 0;color:#333;font-weight:500}
    .exemplo-container{width:90%;max-width:400px;margin:20px auto;border:2px dashed #007bff;border-radius:12px;overflow:hidden;background:#f0f8ff;padding:10px}
    .exemplo-img{width:100%;height:auto;max-height:300px;object-fit:contain;border-radius:8px;display:block;margin:0 auto}
    #loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,123,255,0.9);color:white;padding:25px;border-radius:12px;font-size:17px;z-index:9999;text-align:center}
    .spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid white;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="c">
    <img src="logo.png" alt="Extra Transportes" class="logo" onerror="this.style.display='none'">
    <h2>Comprovante de Entrega</h2>

    <div class="obs">
      <p>Fotos devem ser nítidas e bem iluminadas.<br>
      Fotos não Legíveis serão solicitadas novamente.<br>
      O site pedirá permissões — clique em "Permitir" para continuar.</p>
      <div class="exemplo-container">
        <img src="exemplo.jpg" alt="Foto de exemplo" class="exemplo-img" onerror="this.style.display='none'">
      </div>
    </div>

    <input type="text" id="placa" placeholder="Placa (ex: ABC1D23)" maxlength="7">
    <input type="text" id="motorista" placeholder="Nome do Motorista" disabled>
    <input type="text" id="nota" placeholder="Número da Nota/CT-e" disabled>
    <button onclick="iniciar()" id="btnIniciar" style="display:none">Iniciar Comprovante</button>
    <div class="fotos" id="fotos" style="display:none"></div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <button onclick="gerarESalvarPDF()" id="env" style="display:none">Enviar para Transportadora</button>
    <p id="ok"></p>
  </div>

  <div id="loading"><div class="spinner"></div> Gerando PDF e enviando...</div>

  <script>
    const { jsPDF } = window.jspdf;
    let fotos = [], lat = null, lng = null, gpsPronto = false, placaValida = false;

    const inputPlaca = document.getElementById('placa');
    const inputMotorista = document.getElementById('motorista');
    const inputNota = document.getElementById('nota');
    const btnIniciar = document.getElementById('btnIniciar');
    const containerFotos = document.getElementById('fotos');
    const btnEnviar = document.getElementById('env');
    const okMsg = document.getElementById('ok');

    // ATUALIZE ESTE LINK DEPOIS DE CRIAR A NOVA IMPLANTAÇÃO
    const URL_VERIFICACAO_PLACAS = 'https://script.google.com/macros/s/AKfycbwx02Qirtq2QNhzvR1ACqF4W_ZmBHcS3NgVvVDe1MEg2HnHtNJxWdvpWfP-mSyASuGimw/exec';
    const URL_SALVAR_PDF = 'https://script.google.com/macros/s/AKfycbyfazQSnUmRm2dN6fwPqK4EfR9vS6TAR1B3m-55WhpgTZXeo4CQx2L20rLQi4QKnCa6wA/exec';

    function bloquearFormulario() {
      inputMotorista.disabled = true; inputNota.disabled = true;
      btnIniciar.style.display = 'none'; containerFotos.style.display = 'none'; btnEnviar.style.display = 'none';
    }
    function liberarFormulario() {
      inputMotorista.disabled = false; inputNota.disabled = false;
      btnIniciar.style.display = 'block'; containerFotos.style.display = 'block';
      okMsg.innerHTML = '<span style="color:green">Placa válida! Preencha os dados.</span>';
    }
    bloquearFormulario();

    inputPlaca.addEventListener('input', function(e) {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0,7);
      e.target.value = v;
      if (v.length === 7 && /^[A-Z]{3}\d[A-Z0-9]\d{2}$/.test(v)) verificarPlacaNoGoogleSheets(v);
      else { bloquearFormulario(); okMsg.innerHTML = ''; placaValida = false; }
    });

    function verificarPlacaNoGoogleSheets(placa) {
      okMsg.innerHTML = '<span style="color:#007bff">Verificando placa...</span>';
      fetch(URL_VERIFICACAO_PLACAS).then(r=>r.json()).then(d=>{
        if (d.placas && d.placas.includes(placa)) { placaValida = true; liberarFormulario(); }
        else { bloquearFormulario(); okMsg.innerHTML = '<span style="color:red">Placa não autorizada!</span>'; }
      }).catch(()=>{ okMsg.innerHTML = '<span style="color:red">Erro de conexão.</span>'; bloquearFormulario(); });
    }

    function formatarDataHora() {
      const a = new Date();
      return `${String(a.getDate()).padStart(2,'0')}/${String(a.getMonth()+1).padStart(2,'0')}/${a.getFullYear()} ${String(a.getHours()).padStart(2,'0')}:${String(a.getMinutes()).padStart(2,'0')}`;
    }

    function iniciar() {
      if (!placaValida) return alert("Placa não validada!");
      if (!inputMotorista.value.trim() || !inputNota.value.trim()) return alert("Preencha todos os campos!");
      if (!gpsPronto) {
        navigator.geolocation.getCurrentPosition(p=>{
          lat = p.coords.latitude.toFixed(6); lng = p.coords.longitude.toFixed(6); gpsPronto = true; tirarFoto();
        }, ()=>alert("Permita o GPS!"));
      } else tirarFoto();
    }

    function adicionarMarcaDagua(file, callback) {
      const r = new FileReader();
      r.onload = e => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          const ctx = c.getContext('2d');
          c.width = img.width; c.height = img.height;
          ctx.drawImage(img, 0, 0);
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(0, img.height-110, img.width, 110);
          ctx.font = 'bold 35px Arial'; ctx.fillStyle = '#00ff00'; ctx.textAlign = 'right';
          ctx.fillText('ENTREGUE', img.width-20, img.height-70);
          ctx.font = '22px Arial'; ctx.fillStyle = '#ffffff';
          ctx.fillText(formatarDataHora(), img.width-20, img.height-40);
          ctx.fillStyle = '#ffff00';
          ctx.fillText(`${lat}, ${lng}`, img.width-20, img.height-10);
          c.toBlob(b=>callback(new File([b], file.name, {type:'image/jpeg'}))), 'image/jpeg', 0.92);
        };
        img.src = e.target.result;
      };
      r.readAsDataURL(file);
    }

    function tirarFoto() {
      document.getElementById('loading').style.display = 'block';
      const i = document.createElement('input');
      i.type = 'file'; i.accept = 'image/*'; i.capture = 'environment';
      i.onchange = ev => {
        const f = ev.target.files[0];
        if (!f) { document.getElementById('loading').style.display = 'none'; return; }
        adicionarMarcaDagua(f, fotoComMarca => {
          document.getElementById('loading').style.display = 'none';
          const div = document.createElement('div'); div.className = 'foto-prev';
          const img = document.createElement('img'); img.src = URL.createObjectURL(fotoComMarca);
          img.style.width = img.style.height = '100%'; img.style.objectFit = 'cover';
          const x = document.createElement('div'); x.textContent = '×'; x.className = 'remover';
          x.onclick = () => { fotos = fotos.filter(ff=>ff!==fotoComMarca); div.remove(); atualizarBotao(); };
          div.appendChild(img); div.appendChild(x);
          containerFotos.appendChild(div);
          fotos.push(fotoComMarca);
          mostrarAdicionarMais();
        });
      };
      i.click();
    }

    function mostrarAdicionarMais() {
      document.querySelectorAll('.camera-actions').forEach(el=>el.remove());
      const div = document.createElement('div'); div.className = 'camera-actions';
      const btn = document.createElement('button'); btn.textContent = 'Adicionar Mais';
      btn.onclick = tirarFoto; div.appendChild(btn); containerFotos.appendChild(div);
      atualizarBotao();
    }

    function atualizarBotao() { btnEnviar.style.display = fotos.length > 0 ? 'block' : 'none'; }

    // ============ NOVA FUNÇÃO: GERA PDF E ENVIA ============
    async function gerarESalvarPDF() {
      if (fotos.length === 0) return alert("Tire pelo menos uma foto!");

      document.getElementById('loading').style.display = 'block';
      btnEnviar.disabled = true;
      okMsg.innerHTML = "Gerando PDF...";

      const pdf = new jsPDF();
      const w = pdf.internal.pageSize.getWidth();
      const h = pdf.internal.pageSize.getHeight();

      for (let i = 0; i < fotos.length; i++) {
        if (i > 0) pdf.addPage();
        const dataUrl = await new Promise(r => { const fr = new FileReader(); fr.onload = ()=>r(fr.result); fr.readAsDataURL(fotos[i]); });
        const imgProps = pdf.getImageProperties(dataUrl);
        let largura = w - 30;
        let altura = (imgProps.height / imgProps.width) * largura;
        if (altura > h - 50) { altura = h - 50; largura = (imgProps.width / imgProps.height) * altura; }
        const x = (w - largura) / 2;
        const y = (h - altura) / 2 - 10;
        pdf.addImage(dataUrl, 'JPEG', x, y, largura, altura);

        pdf.setFontSize(10);
        pdf.text(`Nota: ${inputNota.value.trim()} | Motorista: ${inputMotorista.value.trim()} | Placa: ${inputPlaca.value.trim()}`, 10, h - 15);
        pdf.text(`GPS: ${lat}, ${lng} | ${formatarDataHora()}`, 10, h - 8);
      }

      const pdfBlob = pdf.output('blob');
      const nomePDF = `${inputNota.value.trim()}_${inputPlaca.value.trim()}_${new Date().toISOString().slice(0,16).replace(/[-T:]/g,'')}.pdf`;

      const fd = new FormData();
      fd.append('file', pdfBlob, nomePDF);
      fd.append('nota', inputNota.value.trim());
      fd.append('placa', inputPlaca.value.trim());
      fd.append('motorista', inputMotorista.value.trim());
      fd.append('lat', lat);
      fd.append('lng', lng);

      fetch(URL_SALVAR_PDF, { method: 'POST', body: fd })
        .then(r => r.text())
        .then(() => {
          document.getElementById('loading').style.display = 'none';
          okMsg.innerHTML = "PDF enviado com sucesso!";
          const msg = `Entrega ${inputNota.value.trim()} – ${fotos.length} foto(s) em PDF\nMotorista: ${inputMotorista.value.trim()}\nPlaca: ${inputPlaca.value.trim()}\nhttps://maps.google.com/?q=${lat},${lng}`;
          window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
          setTimeout(()=>location.reload(), 4000);
        })
        .catch(() => {
          document.getElementById('loading').style.display = 'none';
          alert("Erro no envio. Verifique a conexão e tente novamente.");
          btnEnviar.disabled = false;
        });
    }
  </script>
</body>
</html>
